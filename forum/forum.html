<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>4EXT Forum</title>
  <link rel="stylesheet" href="../styles.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <style>
    :root {
      --primary: #7f9cf5;
      --primary-dark: #667eea;
      --accent: #ff6b6b;
      --bg: #181a20;
      --bg-card: #23262e;
      --border: #23262e;
      --error: #e53e3e;
      --input-bg: #23262e;
      --input-border: #353945;
      --input-focus: #7f9cf5;
      --text: #fff;
      --text-muted: #a0a0a0;
      --shadow: 0 4px 32px #0008;
      --radius: 16px;
      --gradient: linear-gradient(135deg, #667eea 0%, #7f9cf5 50%, #ff6b6b 100%);
    }
    body {
      background: linear-gradient(120deg, #23262e 0%, #181a20 100%);
      color: var(--text);
      font-family: 'Inter', Arial, sans-serif;
      min-height: 100vh;
      margin: 0;
    }
    .centered-flex {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
    }
    .auth-card {
      background: var(--bg-card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 2.5rem 2.5rem 2rem 2.5rem;
      width: 100%;
      max-width: 420px;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      gap: 1.2rem;
      border: 2px solid var(--primary);
      background-image: var(--gradient);
      background-size: 200% 200%;
      animation: gradientMove 6s ease-in-out infinite alternate;
    }
    @keyframes gradientMove {
      0% { background-position: 0% 50%; }
      100% { background-position: 100% 50%; }
    }
    .auth-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
      text-align: center;
      margin-bottom: 0.5rem;
      letter-spacing: 1px;
      text-shadow: 0 2px 8px #0006;
    }
    .auth-error {
      background: rgba(229,62,62,0.12);
      color: var(--error);
      border: 1px solid var(--error);
      border-radius: 8px;
      padding: 0.8rem 1rem;
      font-size: 1.05em;
      display: flex;
      align-items: center;
      gap: 0.7rem;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }
    .auth-tabs {
      display: flex;
      justify-content: center;
      gap: 2rem;
      margin-bottom: 1.2rem;
    }
    .auth-tab {
      font-size: 1.1em;
      font-weight: 600;
      color: #888;
      background: none;
      border: none;
      cursor: pointer;
      padding: 0.5rem 1.5rem;
      border-radius: 8px 8px 0 0;
      transition: color 0.2s, background 0.2s;
    }
    .auth-tab.active {
      color: var(--text);
      background: var(--input-bg);
      box-shadow: 0 2px 8px #0003;
    }
    .auth-form {
      display: flex;
      flex-direction: column;
      gap: 1.1rem;
    }
    .auth-label {
      font-size: 1em;
      color: var(--text-muted);
      margin-bottom: 0.2rem;
      font-weight: 500;
    }
    .auth-input-row {
      position: relative;
      display: flex;
      align-items: center;
    }
    .auth-input {
      width: 100%;
      padding: 0.9rem 1.1rem;
      border-radius: 8px;
      border: 1.5px solid var(--input-border);
      background: var(--input-bg);
      color: var(--text);
      font-size: 1.08em;
      outline: none;
      transition: border 0.2s, box-shadow 0.2s;
      box-shadow: 0 2px 8px #0002;
    }
    .auth-input:focus {
      border-color: var(--input-focus);
      box-shadow: 0 0 0 2px var(--primary-dark);
    }
    .auth-input::placeholder {
      color: #888;
      opacity: 1;
    }
    .auth-show {
      position: absolute;
      right: 1rem;
      top: 50%;
      transform: translateY(-50%);
      color: #888;
      background: none;
      border: none;
      font-size: 1em;
      cursor: pointer;
      padding: 0 0.2rem;
    }
    .auth-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
    }
    .auth-checkbox {
      accent-color: var(--primary);
      margin-right: 0.5rem;
    }
    .auth-btn {
      width: 100%;
      padding: 0.95rem 0;
      border-radius: 8px;
      border: none;
      background: linear-gradient(135deg, #667eea 0%, #ff6b6b 100%);
      color: #fff;
      font-size: 1.1em;
      font-weight: 700;
      cursor: pointer;
      margin-top: 0.2rem;
      box-shadow: 0 2px 8px #0003;
      transition: background 0.2s, transform 0.2s;
    }
    .auth-btn:hover {
      background: linear-gradient(135deg, #ff6b6b 0%, #667eea 100%);
      transform: translateY(-2px) scale(1.03);
    }
    .auth-footer {
      text-align: center;
      color: #888;
      font-size: 1em;
      margin-top: 0.7rem;
    }
    .auth-footer a {
      color: var(--primary);
      text-decoration: none;
      font-weight: 600;
      margin-left: 0.3rem;
      transition: color 0.2s;
    }
    .auth-footer a:hover {
      color: var(--accent);
    }
    .auth-or {
      text-align: center;
      color: #888;
      font-size: 1em;
      margin: 1.2rem 0 0.7rem 0;
      position: relative;
    }
    .auth-or:before, .auth-or:after {
      content: '';
      display: inline-block;
      width: 40%;
      height: 1px;
      background: #23262e;
      vertical-align: middle;
      margin: 0 0.7rem;
    }
    .auth-socials {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-top: 0.2rem;
    }
    .auth-social-btn {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      background: linear-gradient(135deg, #23262e 0%, #353945 100%);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 1.08em;
      font-weight: 600;
      padding: 0.8rem 0;
      cursor: pointer;
      box-shadow: 0 2px 8px #0002;
      transition: background 0.2s;
    }
    .auth-social-btn:hover {
      background: linear-gradient(135deg, #353945 0%, #23262e 100%);
    }
    .auth-social-btn i {
      font-size: 1.2em;
    }
    /* Forum styles (shoutbox) */
    .shoutbox-main-container {
      width: var(--shoutbox-width, 600px);
      min-width: 320px;
      max-width: 98vw;
      background: var(--bg-card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 0 0 0.5rem 0;
      overflow: hidden;
      flex-shrink: 0;
      margin: 40px auto;
      border: 2px solid var(--primary);
      background-image: var(--gradient);
      background-size: 200% 200%;
      animation: gradientMove 6s ease-in-out infinite alternate;
      resize: none;
      position: relative;
    }
    .shoutbox-header {
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      padding: 1.2rem 2rem 1.2rem 2rem;
      display: flex;
      align-items: center;
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--primary);
      letter-spacing: 0.5px;
    }
    .shoutbox-header i {
      margin-right: 10px;
      color: var(--primary);
    }
    .shoutbox-messages {
      max-height: 500px;
      min-height: 200px;
      overflow-y: auto;
      padding: 1.2rem 2rem 0.5rem 2rem;
      background: var(--bg-card);
      scrollbar-width: thin;
      display: flex;
      flex-direction: column;
      gap: 1.1rem;
      transition: height 0.2s;
    }
    .shoutbox-resize-handle {
      width: 100%;
      height: 12px;
      cursor: ns-resize;
      background: linear-gradient(90deg, #23262e 60%, #7f9cf5 100%);
      border-bottom-left-radius: 12px;
      border-bottom-right-radius: 12px;
      position: absolute;
      bottom: 0;
      left: 0;
      z-index: 10;
      opacity: 0.7;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .shoutbox-resize-bar {
      width: 60px;
      height: 4px;
      background: #7f9cf5;
      border-radius: 2px;
      margin: 4px 0;
    }
    .shoutbox-context-menu {
      position: fixed;
      z-index: 9999;
      background: #23262e;
      border: 1.5px solid #7f9cf5;
      border-radius: 12px;
      box-shadow: 0 8px 32px #000a;
      min-width: 140px;
      color: #fff;
      font-size: 1em;
      display: none;
      flex-direction: column;
      padding: 0.3em 0;
      animation: fadeInScale 0.18s;
      overflow: hidden;
    }
    .shoutbox-context-menu button {
      background: none;
      border: none;
      color: #fff;
      text-align: left;
      padding: 0.9em 1.5em;
      font-size: 1em;
      cursor: pointer;
      width: 100%;
      transition: background 0.18s, color 0.18s;
    }
    .shoutbox-context-menu button:hover {
      background: #353945;
      color: #7f9cf5;
    }
    @keyframes fadeInScale {
      from { opacity: 0; transform: scale(0.92); }
      to { opacity: 1; transform: scale(1); }
    }
    .shoutbox-message {
      display: flex;
      align-items: flex-start;
      gap: 0.8rem;
      background: #23262e;
      border-radius: 10px;
      padding: 0.7rem 1.1rem 0.7rem 0.9rem;
      box-shadow: 0 1px 4px #0003;
      position: relative;
    }
    .shoutbox-message .pfp {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #23262e;
      border: 2px solid #7f9cf5;
      object-fit: cover;
      flex-shrink: 0;
    }
    .shoutbox-message-content {
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
      width: 100%;
    }
    .shoutbox-message-meta {
      font-size: 0.97em;
      color: #fff;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 0.7rem;
    }
    .shoutbox-message-time {
      color: #888;
      font-size: 0.92em;
      font-weight: 400;
    }
    .shoutbox-message-body {
      color: #fff;
      font-size: 1.08em;
      word-break: break-word;
      margin-top: 2px;
    }
    .shoutbox-input-bar {
      display: flex;
      align-items: center;
      gap: 0.7rem;
      background: var(--bg-card);
      border-top: 1px solid var(--border);
      padding: 1.1rem 2rem 1.1rem 2rem;
    }
    .shoutbox-input-bar input {
      flex: 1;
      border-radius: 8px;
      border: none;
      background: var(--input-bg);
      color: #fff;
      font-size: 1em;
      padding: 10px 12px;
    }
    .shoutbox-input-bar button {
      background: linear-gradient(135deg, #667eea 0%, #ff6b6b 100%);
      color: #fff;
      border: none;
      padding: 10px 22px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 1em;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .shoutbox-input-bar button:hover {
      background: linear-gradient(135deg, #ff6b6b 0%, #667eea 100%);
    }
    @media (max-width: 600px) {
      .auth-card, .shoutbox-main-container {
        padding: 1.2rem 0.5rem 1.2rem 0.5rem;
        max-width: 98vw;
      }
    }
    .user-profile-bar {
      position: fixed;
      top: 0;
      right: 0;
      z-index: 2000;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 18px 32px 0 0;
    }
    .user-profile-bar .username {
      font-weight: 600;
      color: #fff;
      font-size: 1.08em;
      background: #23262e;
      padding: 6px 16px;
      border-radius: 8px 0 0 8px;
      letter-spacing: 0.2px;
      box-shadow: 0 2px 8px #0003;
    }
    .user-profile-bar .pfp {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      background: #23262e;
      border: 2px solid #7f9cf5;
      object-fit: cover;
      cursor: pointer;
      transition: box-shadow 0.2s;
    }
    .user-profile-bar .pfp:hover {
      box-shadow: 0 0 0 3px #7f9cf5;
    }
    .profile-dropdown {
      position: absolute;
      top: 60px;
      right: 32px;
      background: #23262e;
      border-radius: 10px;
      box-shadow: 0 4px 24px #0008;
      min-width: 160px;
      padding: 0.5rem 0;
      display: none;
      flex-direction: column;
      z-index: 3000;
      animation: fadeIn 0.2s;
    }
    .profile-dropdown.show {
      display: flex;
    }
    .profile-dropdown button {
      background: none;
      border: none;
      color: #e53e3e;
      font-weight: 700;
      font-size: 1em;
      padding: 12px 24px;
      text-align: left;
      cursor: pointer;
      border-radius: 8px;
      transition: background 0.2s;
    }
    .profile-dropdown button:hover {
      background: #3a2a2a;
    }
    .login-layout {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(120deg, #23262e 0%, #181a20 100%);
    }
    .login-card {
      display: flex;
      flex-direction: column;
      background: var(--bg-card);
      border-radius: 18px;
      box-shadow: 0 4px 32px #0008;
      overflow: hidden;
      max-width: 420px;
      width: 100%;
      margin: 40px auto;
      border: 2px solid var(--primary);
      background-image: var(--gradient);
      background-size: 200% 200%;
      animation: gradientMove 6s ease-in-out infinite alternate;
    }
    .login-form-col {
      flex: 1 1 420px;
      background: rgba(24,26,32,0.98);
      padding: 2.5rem 2.5rem 2rem 2.5rem;
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 1.2rem;
    }
    .login-title {
      font-size: 2rem;
      font-weight: 800;
      color: var(--primary);
      margin-bottom: 0.5rem;
      letter-spacing: 1px;
      text-shadow: 0 2px 8px #0006;
      text-align: left;
    }
    .login-error {
      background: rgba(229,62,62,0.12);
      color: var(--error);
      border: 1px solid var(--error);
      border-radius: 8px;
      padding: 0.8rem 1rem;
      font-size: 1.05em;
      display: flex;
      align-items: center;
      gap: 0.7rem;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }
    .login-tabs {
      display: flex;
      gap: 2rem;
      margin-bottom: 1.2rem;
    }
    .login-tab {
      font-size: 1.1em;
      font-weight: 600;
      color: #888;
      background: none;
      border: none;
      cursor: pointer;
      padding: 0.5rem 1.5rem;
      border-radius: 8px 8px 0 0;
      transition: color 0.2s, background 0.2s;
    }
    .login-tab.active {
      color: var(--text);
      background: var(--input-bg);
      box-shadow: 0 2px 8px #0003;
    }
    .login-form {
      display: flex;
      flex-direction: column;
      gap: 1.1rem;
    }
    .login-label {
      font-size: 1em;
      color: var(--text-muted);
      margin-bottom: 0.2rem;
      font-weight: 500;
    }
    .login-input-row {
      position: relative;
      display: flex;
      align-items: center;
    }
    .login-input {
      width: 100%;
      padding: 0.9rem 1.1rem;
      border-radius: 8px;
      border: 1.5px solid var(--input-border);
      background: var(--input-bg);
      color: var(--text);
      font-size: 1.08em;
      outline: none;
      transition: border 0.2s, box-shadow 0.2s;
      box-shadow: 0 2px 8px #0002;
    }
    .login-input:focus {
      border-color: var(--input-focus);
      box-shadow: 0 0 0 2px var(--primary-dark);
    }
    .login-input::placeholder {
      color: #888;
      opacity: 1;
    }
    .login-show {
      position: absolute;
      right: 1rem;
      top: 50%;
      transform: translateY(-50%);
      color: #888;
      background: none;
      border: none;
      font-size: 1em;
      cursor: pointer;
      padding: 0 0.2rem;
    }
    .login-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
    }
    .login-checkbox {
      accent-color: var(--primary);
      margin-right: 0.5rem;
    }
    .login-btn {
      width: 100%;
      padding: 0.95rem 0;
      border-radius: 8px;
      border: none;
      background: linear-gradient(135deg, #667eea 0%, #ff6b6b 100%);
      color: #fff;
      font-size: 1.1em;
      font-weight: 700;
      cursor: pointer;
      margin-top: 0.2rem;
      box-shadow: 0 2px 8px #0003;
      transition: background 0.2s, transform 0.2s;
    }
    .login-btn:hover {
      background: linear-gradient(135deg, #ff6b6b 0%, #667eea 100%);
      transform: translateY(-2px) scale(1.03);
    }
    .login-footer {
      text-align: center;
      color: #888;
      font-size: 1em;
      margin-top: 0.7rem;
    }
    .login-footer a {
      color: var(--primary);
      text-decoration: none;
      font-weight: 600;
      margin-left: 0.3rem;
      transition: color 0.2s;
    }
    .login-footer a:hover {
      color: var(--accent);
    }
    .login-or {
      text-align: center;
      color: #888;
      font-size: 1em;
      margin: 1.2rem 0 0.7rem 0;
      position: relative;
    }
    .login-or:before, .login-or:after {
      content: '';
      display: inline-block;
      width: 40%;
      height: 1px;
      background: #23262e;
      vertical-align: middle;
      margin: 0 0.7rem;
    }
    .login-socials {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-top: 0.2rem;
    }
    .login-social-btn {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      background: linear-gradient(135deg, #23262e 0%, #353945 100%);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 1.08em;
      font-weight: 600;
      padding: 0.8rem 0;
      cursor: pointer;
      box-shadow: 0 2px 8px #0002;
      transition: background 0.2s;
    }
    .login-social-btn:hover {
      background: linear-gradient(135deg, #353945 0%, #23262e 100%);
    }
    .login-social-btn i {
      font-size: 1.2em;
    }
    @media (max-width: 900px) {
      .login-card {
        flex-direction: column;
        max-width: 98vw;
      }
    }
    /* Add CSS for the dots button */
    .shoutbox-dots-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      color: #bfc3d1;
      font-size: 1.25em;
      padding: 4px 8px;
      border-radius: 7px;
      z-index: 2;
      box-shadow: none;
      border: none;
      transition: background 0.15s, color 0.15s, transform 0.15s;
    }
    .shoutbox-dots-btn:hover, .shoutbox-dots-btn:focus {
      background: #23262e;
      color: #fff;
      outline: none;
    }
    .shoutbox-dots-btn:active {
      background: #181a20;
      color: #7f9cf5;
    }
    .shoutbox-edit-input {
      width: 100%;
      margin-top: 4px;
      padding: 0.8em 1em;
      border-radius: 10px;
      border: 1.5px solid var(--input-border);
      background: var(--input-bg);
      color: var(--text);
      font-size: 1.08em;
      outline: none;
      transition: border 0.2s, box-shadow 0.2s, background 0.18s;
      box-shadow: 0 2px 8px #0002;
      margin-bottom: 0.5em;
      animation: fadeInScale 0.18s;
    }
    .shoutbox-edit-input:focus {
      border-color: var(--input-focus);
      box-shadow: 0 0 0 2px var(--primary-dark);
      background: #23262e;
    }
    .shoutbox-edit-apply, .shoutbox-edit-cancel, #delete-yes, #delete-no {
      border: none;
      border-radius: 10px;
      padding: 0.7em 1.5em;
      font-size: 1em;
      font-weight: 700;
      cursor: pointer;
      margin-right: 0.5em;
      margin-bottom: 0.2em;
      transition: background 0.2s, color 0.2s, box-shadow 0.2s, transform 0.18s;
      box-shadow: 0 2px 12px #0003;
      outline: none;
      background: linear-gradient(135deg, #667eea 0%, #7f9cf5 100%);
      color: #fff;
      position: relative;
      overflow: hidden;
    }
    .shoutbox-edit-apply:hover, #delete-yes:hover {
      background: linear-gradient(135deg, #7f9cf5 0%, #667eea 100%);
      color: #fff;
      transform: scale(1.06);
      box-shadow: 0 4px 24px #7f9cf588;
    }
    .shoutbox-edit-cancel, #delete-no {
      background: #353945;
      color: #fff;
    }
    .shoutbox-edit-cancel:hover, #delete-no:hover {
      background: #23262e;
      color: #ff6b6b;
      transform: scale(1.06);
    }
    .shoutbox-delete-box {
      background: var(--bg-card);
      border-radius: 18px;
      box-shadow: 0 8px 32px #000a;
      padding: 2em 2.5em 1.5em 2.5em;
      display: flex;
      flex-direction: column;
      align-items: center;
      border: 2px solid var(--primary);
      min-width: 220px;
      margin: auto;
      animation: fadeInScale 0.22s;
    }
    .shoutbox-delete-confirm {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(24,26,32,0.85);
      z-index: 99999;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: fadeInScale 0.22s;
    }
    .shoutbox-send-btn {
      padding: 10px 22px;
      border-radius: 10px;
      font-size: 1em;
      font-weight: 700;
      background: linear-gradient(135deg, #667eea 0%, #ff6b6b 100%);
      color: #fff;
      box-shadow: 0 2px 8px #0003;
      transition: background 0.2s, transform 0.18s;
    }
    .shoutbox-send-btn:hover {
      background: linear-gradient(135deg, #ff6b6b 0%, #667eea 100%);
      transform: scale(1.06);
    }
    .members-online-box {
      position: fixed;
      top: 90px;
      right: 32px;
      background: #20212a;
      border-radius: 16px;
      box-shadow: 0 4px 32px #0008;
      padding: 1.3em 1.7em 1.1em 1.7em;
      min-width: 260px;
      z-index: 10;
      border: 1.5px solid #23262e;
      color: #fff;
      font-family: 'Inter', Arial, sans-serif;
      animation: fadeInScale 0.22s;
      transition: transform 0.35s cubic-bezier(.77,0,.18,1), opacity 0.25s;
      will-change: transform, opacity;
    }
    .members-online-box.hide {
      transform: translateX(120%);
      opacity: 0.1;
      pointer-events: none;
    }
    .members-online-arrow {
      position: absolute;
      left: 100%;
      top: 18px;
      margin-left: 10px;
      width: 32px;
      height: 32px;
      background: #23262e;
      border-radius: 50%;
      box-shadow: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border: 2px solid #23262e;
      color: #7f9cf5;
      font-size: 1.2em;
      z-index: 11;
      transition: background 0.18s, color 0.18s, transform 0.18s;
    }
    .members-online-arrow:hover {
      background: #353945;
      color: #fff;
      transform: scale(1.12);
    }
    .members-online-show-btn {
      position: fixed;
      top: 120px;
      right: 0;
      width: 38px;
      height: 38px;
      background: #23262e;
      border-radius: 50% 0 0 50%;
      box-shadow: 0 2px 8px #0004;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border: 2px solid #23262e;
      color: #7f9cf5;
      font-size: 1.3em;
      z-index: 11;
      transition: background 0.18s, color 0.18s, transform 0.18s;
      opacity: 0.85;
    }
    .members-online-show-btn:hover {
      background: #353945;
      color: #fff;
      transform: scale(1.12);
      opacity: 1;
    }
    .members-online-title {
      font-size: 1.18em;
      font-weight: 800;
      margin-bottom: 0.7em;
      letter-spacing: 0.2px;
    }
    .members-online-list {
      font-size: 1.05em;
      margin-bottom: 0.7em;
      color: #e0e0e0;
      word-break: break-word;
    }
    .members-online-total {
      font-size: 0.98em;
      color: #888;
      background: #23262e;
      border-radius: 8px;
      padding: 0.4em 0.8em;
      margin-top: 0.2em;
      display: inline-block;
    }
    .shoutbox-delete-box {
      background: var(--bg-card);
      border-radius: 18px;
      box-shadow: 0 8px 32px #000a;
      padding: 2em 2.5em 1.5em 2.5em;
      display: flex;
      flex-direction: column;
      align-items: center;
      border: 2px solid var(--primary);
      min-width: 220px;
      margin: auto;
      animation: fadeInScale 0.22s;
    }
    .shoutbox-delete-btn-row {
      display: flex;
      gap: 1em;
      justify-content: center;
      width: 100%;
      margin-top: 1em;
    }
    #delete-yes, #delete-no {
      flex: 1 1 0;
      min-width: 90px;
      max-width: 140px;
      text-align: center;
      margin: 0;
    }
    /* Add CSS for .profile-link */
    .profile-link {
      color: #fff;
      font-weight: 700;
      text-decoration: none;
      transition: color 0.18s;
      border-bottom: 1.5px solid #7f9cf5;
      padding: 0 2px;
      border-radius: 3px;
    }
    .profile-link:hover {
      color: #7f9cf5;
      background: #23262e;
      border-bottom: 1.5px solid #fff;
    }
  </style>
</head>
<body>
  <div id="app"></div>
  <div id="profile-bar-root"></div>
  <div id="forum-stats-bar"></div>
  <script>
    if (!localStorage.getItem('forumCurrentUser')) {
      window.location.href = 'forum.html';
    }
    // --- CONFIG ---
    const API_BASE = 'http://localhost:3001';
    const DEFAULT_PFP = 'https://ui-avatars.com/api/?name=User&background=7f9cf5&color=fff&rounded=true&size=64';
    // --- STATE ---
    function getCurrentUser() {
      return localStorage.getItem('forumCurrentUser') || null;
    }
    function setCurrentUser(username) {
      if (username) localStorage.setItem('forumCurrentUser', username);
      else localStorage.removeItem('forumCurrentUser');
    }
    // --- RENDER ---
    function render() {
      const app = document.getElementById('app');
      const profileBarRoot = document.getElementById('profile-bar-root');
      app.innerHTML = '';
      profileBarRoot.innerHTML = '';
      if (!getCurrentUser()) {
        stopOnlineTracking();
        app.appendChild(renderAuthCard());
      } else {
        app.appendChild(renderForum());
        profileBarRoot.appendChild(renderProfileBar());
        startOnlineTracking();
      }
    }
    // --- AUTH UI ---
    function renderAuthCard() {
      const wrapper = document.createElement('div');
      wrapper.className = 'login-layout';
      wrapper.innerHTML = `
        <div class="login-card">
          <div class="login-form-col">
            <div class="login-title" id="auth-title">Login</div>
            <div class="login-error" id="auth-error" style="display:none;"><i class="fas fa-times-circle"></i> <span id="auth-error-msg"></span></div>
            <div class="login-tabs">
              <button class="login-tab active" id="tab-login" type="button">Login</button>
              <button class="login-tab" id="tab-register" type="button">Register</button>
              </div>
            <form class="login-form" id="login-form" autocomplete="on">
              <label class="login-label" for="login-username">Your name or email address:</label>
              <div class="login-input-row">
                <input class="login-input" id="login-username" type="text" placeholder="Username" maxlength="20" required>
          </div>
              <label class="login-label" for="login-password">Password:</label>
              <div class="login-input-row">
                <input class="login-input" id="login-password" type="password" placeholder="Password" maxlength="32" required>
                <button class="login-show" type="button" id="show-login-password"><i class="fas fa-eye"></i></button>
              </div>
              <div class="login-row">
                <a href="#" style="color:var(--primary);font-size:0.98em;">Forgot your password?</a>
                <div><input type="checkbox" class="login-checkbox" id="stay-logged-in"> <label for="stay-logged-in" style="color:#888;font-size:0.98em;">Stay logged in</label></div>
              </div>
              <button class="login-btn" type="submit">Log in</button>
          </form>
            <form class="login-form" id="register-form" autocomplete="on" style="display:none;">
              <label class="login-label" for="register-username">Your name:</label>
              <div class="login-input-row">
                <input class="login-input" id="register-username" type="text" placeholder="Username" maxlength="20" required>
              </div>
              <label class="login-label" for="register-email">Email:</label>
              <div class="login-input-row">
                <input class="login-input" id="register-email" type="email" placeholder="Email address" maxlength="64" required>
              </div>
              <label class="login-label" for="register-password">Password:</label>
              <div class="login-input-row">
                <input class="login-input" id="register-password" type="password" placeholder="Password" maxlength="32" required>
                <button class="login-show" type="button" id="show-register-password"><i class="fas fa-eye"></i></button>
              </div>
              <button class="login-btn" type="submit">Register</button>
            </form>
            <div class="login-footer">
              <span id="auth-footer-login">Don't have an account?</span>
              <a href="#" id="auth-footer-link">Register now</a>
            </div>
            <div class="login-or">or</div>
            <div class="login-socials">
              <button class="login-social-btn"><i class="fab fa-google"></i> Google</button>
              <button class="login-social-btn"><i class="fab fa-discord"></i> Discord</button>
            </div>
          </div>
        </div>
      `;
      setTimeout(() => attachAuthEvents(), 0);
      return wrapper;
    }
    function attachAuthEvents() {
      // Tab switching
      document.getElementById('tab-login').onclick = showLoginForm;
      document.getElementById('tab-register').onclick = showRegisterForm;
      // Show/hide password
      document.getElementById('show-login-password').onclick = function() { togglePassword('login-password', this); };
      document.getElementById('show-register-password').onclick = function() { togglePassword('register-password', this); };
      // Footer link
      document.getElementById('auth-footer-link').onclick = function(e) {
        e.preventDefault();
        if (document.getElementById('login-form').style.display !== 'none') showRegisterForm();
        else showLoginForm();
      };
      // Form submit
      document.getElementById('login-form').onsubmit = async function(e) {
        e.preventDefault();
        await login();
      };
      document.getElementById('register-form').onsubmit = async function(e) {
        e.preventDefault();
        await register();
      };
    }
    function showLoginForm() {
      document.getElementById('login-form').style.display = '';
      document.getElementById('register-form').style.display = 'none';
      document.getElementById('tab-login').classList.add('active');
      document.getElementById('tab-register').classList.remove('active');
      document.getElementById('auth-title').textContent = 'Login';
      document.getElementById('auth-footer-login').textContent = "Don't have an account?";
      document.getElementById('auth-footer-link').textContent = 'Register now';
      hideAuthError();
    }
    function showRegisterForm() {
      document.getElementById('login-form').style.display = 'none';
      document.getElementById('register-form').style.display = '';
      document.getElementById('tab-login').classList.remove('active');
      document.getElementById('tab-register').classList.add('active');
      document.getElementById('auth-title').textContent = 'Register';
      document.getElementById('auth-footer-login').textContent = 'Already have an account?';
      document.getElementById('auth-footer-link').textContent = 'Login now';
      hideAuthError();
    }
    function togglePassword(inputId, btn) {
      const input = document.getElementById(inputId);
      if (input.type === 'password') {
        input.type = 'text';
        btn.innerHTML = '<i class="fas fa-eye-slash"></i>';
      } else {
        input.type = 'password';
        btn.innerHTML = '<i class="fas fa-eye"></i>';
      }
    }
    function showAuthError(msg) {
      document.getElementById('auth-error').style.display = '';
      document.getElementById('auth-error-msg').textContent = msg;
    }
    function hideAuthError() {
      document.getElementById('auth-error').style.display = 'none';
      document.getElementById('auth-error-msg').textContent = '';
    }
    async function login() {
      hideAuthError();
      const username = document.getElementById('login-username').value.trim();
      const password = document.getElementById('login-password').value;
      if (!username || !password) return showAuthError('Please enter your username and password.');
      try {
        const res = await fetch(`${API_BASE}/api/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });
        if (!res.ok) {
          if (res.status === 401) return showAuthError('Invalid username or password.');
          if (res.status === 404) return showAuthError('User not found.');
          return showAuthError('Login failed.');
        }
        setCurrentUser(username);
        render();
      } catch (e) { showAuthError('Login error.'); }
    }
    // --- Notification system (topmost, modern) ---
    function showTopNotification(message, type = 'info') {
      // Remove existing notification
      const existing = document.getElementById('top-notification');
      if (existing) existing.remove();
      const notif = document.createElement('div');
      notif.id = 'top-notification';
      notif.style.position = 'fixed';
      notif.style.top = '0';
      notif.style.left = '50%';
      notif.style.transform = 'translateX(-50%)';
      notif.style.background = type === 'success' ? 'linear-gradient(90deg,#27ca3f 0%,#67e6dc 100%)' : type === 'error' ? 'linear-gradient(90deg,#ff6b6b 0%,#e53e3e 100%)' : 'linear-gradient(90deg,#667eea 0%,#7f9cf5 100%)';
      notif.style.color = '#fff';
      notif.style.borderRadius = '0 0 18px 18px';
      notif.style.boxShadow = '0 8px 32px #000a';
      notif.style.padding = '1.1em 2.5em';
      notif.style.fontSize = '1.15em';
      notif.style.fontWeight = '700';
      notif.style.zIndex = '999999';
      notif.style.opacity = '0';
      notif.style.transition = 'opacity 0.3s, top 0.3s';
      notif.style.letterSpacing = '0.02em';
      notif.innerHTML = `<span style='margin-right:0.7em;'>${type === 'success' ? '✔️' : type === 'error' ? '❌' : 'ℹ️'}</span>${message}<button style='background:none;border:none;color:#fff;font-size:1.3em;margin-left:1.2em;cursor:pointer;float:right;' onclick='this.parentNode.remove()'>&times;</button>`;
      document.body.appendChild(notif);
      setTimeout(() => { notif.style.opacity = '1'; }, 50);
      setTimeout(() => { if (notif.parentNode) { notif.style.opacity = '0'; setTimeout(() => notif.remove(), 400); } }, 4200);
    }
    // ---
    async function register() {
      hideAuthError();
      const username = document.getElementById('register-username').value.trim();
      const email = document.getElementById('register-email').value.trim();
      const password = document.getElementById('register-password').value;
      // Only allow letters and underscores for username
      if (!/^[a-zA-Z_]+$/.test(username)) {
        showTopNotification('Username must contain only letters (A-Z, a-z) and underscores (_).', 'error');
        return;
      }
      if (!username || !password || !email) { showTopNotification('Please enter a username, email, and password.', 'error'); return; }
      if (!/^([a-zA-Z0-9_\-.+]+)@([a-zA-Z0-9\-.]+)\.([a-zA-Z]{2,})$/.test(email)) { showTopNotification('Please enter a valid email address.', 'error'); return; }
      // Generate 4-char code
      const code = Math.random().toString(36).substring(2, 6).toUpperCase();
      // Send code via EmailJS
      if (!window.emailjs) { showTopNotification('Email service not loaded.', 'error'); return; }
      emailjs.init('z2WmcwjGtarSEt6kH');
      const now = new Date();
      const time = now.toLocaleString();
      const templateParams = {
        time,
        name: username,
        message: `Your verification code is: ${code}`,
        email,
        title: '4EXT Forum Registration Verification'
      };
      try {
        await emailjs.send('service_s228403', 'template_byoru3i', templateParams);
        showTopNotification('Verification code sent to your email.', 'success');
      } catch (e) {
        showTopNotification('Failed to send verification email.', 'error');
        return;
      }
      // Show code input
      showCodeInputPopup(code, async (enteredCode) => {
        if (enteredCode !== code) {
          showTopNotification('Incorrect code. Please try again.', 'error');
          showCodeInputPopup(code, arguments.callee);
          return;
        }
        showTopNotification('Verification successful! Registering...', 'success');
        // Proceed with registration
        try {
          const res = await fetch(`${API_BASE}/api/register`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password, email })
          });
          if (!res.ok) {
            if (res.status === 409) { showTopNotification('Username already exists.', 'error'); return; }
            if (res.status === 404) { showTopNotification('Registration endpoint not found.', 'error'); return; }
            showTopNotification('Registration failed.', 'error');
            return;
          }
          setCurrentUser(username);
          showTopNotification('Registration successful! Welcome.', 'success');
          render();
        } catch (e) { showTopNotification('Registration error.', 'error'); }
      });
    }
    // --- Popup helpers ---
    function showPopup(message, onOk) {
      let popup = document.getElementById('register-popup');
      if (!popup) {
        popup = document.createElement('div');
        popup.id = 'register-popup';
        popup.style.position = 'fixed';
        popup.style.top = '0';
        popup.style.left = '0';
        popup.style.width = '100vw';
        popup.style.height = '100vh';
        popup.style.background = 'rgba(24,24,40,0.55)';
        popup.style.display = 'flex';
        popup.style.alignItems = 'center';
        popup.style.justifyContent = 'center';
        popup.style.zIndex = '99999';
        popup.innerHTML = `<div style="background:#23262e;padding:2.2em 2.5em;border-radius:16px;box-shadow:0 4px 32px #0008;min-width:320px;max-width:90vw;text-align:center;color:#fff;font-size:1.15em;"><div id="register-popup-msg"></div><button id="register-popup-ok" style="margin-top:1.5em;padding:0.7em 2.2em;border-radius:8px;background:linear-gradient(135deg,#667eea 0%,#ff6b6b 100%);color:#fff;font-weight:700;font-size:1em;border:none;cursor:pointer;">OK</button></div>`;
        document.body.appendChild(popup);
      }
      document.getElementById('register-popup-msg').textContent = message;
      popup.style.display = 'flex';
      document.getElementById('register-popup-ok').onclick = function() {
        popup.style.display = 'none';
        if (onOk) onOk();
      };
    }
    function showCodeInputPopup(code, onVerify) {
      let popup = document.getElementById('register-popup');
      if (!popup) {
        popup = document.createElement('div');
        popup.id = 'register-popup';
        document.body.appendChild(popup);
      }
      popup.style.position = 'fixed';
      popup.style.top = '0';
      popup.style.left = '0';
      popup.style.width = '100vw';
      popup.style.height = '100vh';
      popup.style.background = 'rgba(24,24,40,0.55)';
      popup.style.display = 'flex';
      popup.style.alignItems = 'center';
      popup.style.justifyContent = 'center';
      popup.style.zIndex = '99999';
      popup.innerHTML = `<div style="background:#23262e;padding:2.2em 2.5em;border-radius:16px;box-shadow:0 4px 32px #0008;min-width:320px;max-width:90vw;text-align:center;color:#fff;font-size:1.15em;"><div style='margin-bottom:1.2em;'>Enter the 4-character code sent to your email:</div><input id="register-code-input" maxlength="4" style="font-size:1.5em;text-align:center;letter-spacing:0.4em;padding:0.7em 1.2em;border-radius:8px;border:1.5px solid #7f9cf5;background:#181a20;color:#fff;width:8em;outline:none;"><br><button id="register-code-ok" style="margin-top:1.5em;padding:0.7em 2.2em;border-radius:8px;background:linear-gradient(135deg,#667eea 0%,#ff6b6b 100%);color:#fff;font-weight:700;font-size:1em;border:none;cursor:pointer;">Verify</button></div>`;
      document.getElementById('register-code-ok').onclick = function() {
        const entered = document.getElementById('register-code-input').value.trim().toUpperCase();
        if (onVerify) onVerify(entered);
        popup.style.display = 'none';
      };
    }
    // --- FORUM UI ---
    let messages = [];
    let shoutboxInterval = null;
    let editingMessageId = null;
    let contextMsgId = null;
    let deleteId = null;
    function renderForum() {
      const width = localStorage.getItem('shoutbox-width') || '600px';
      const height = localStorage.getItem('shoutbox-height') || '500px';
      document.documentElement.style.setProperty('--shoutbox-width', width);
      const wrapper = document.createElement('div');
      wrapper.className = 'centered-flex';
      wrapper.innerHTML = `
        <div class="shoutbox-main-container" style="width:${width};">
          <div class="shoutbox-header">
            <i class="fas fa-comments"></i> Shoutbox
            <button id="refresh-shoutbox" title="Refresh" style="margin-left:auto;background:linear-gradient(135deg,#667eea,#7f9cf5);color:#fff;border:none;padding:6px 18px;border-radius:8px;cursor:pointer;font-weight:bold;box-shadow:0 2px 8px #0002;transition:background 0.2s;"><i class="fas fa-sync-alt"></i></button>
          </div>
          <div class="shoutbox-messages" id="shoutbox-messages" style="max-height:${height};"></div>
          <div class="shoutbox-input-bar">
            <input type="text" id="shoutbox-input" placeholder="Type a message..." maxlength="500" autocomplete="off">
            <button id="shoutbox-send" class="shoutbox-send-btn"><i class="fas fa-paper-plane"></i></button>
          </div>
          <div class="shoutbox-resize-handle"><div class="shoutbox-resize-bar"></div></div>
        </div>
        <div class="shoutbox-context-menu" id="shoutbox-context-menu">
          <button id="edit-message-btn">Edit message</button>
          <button id="delete-message-btn" style="color:#ff6b6b;">Delete</button>
        </div>
        <div class="shoutbox-delete-confirm" id="shoutbox-delete-confirm" style="display:none;">
          <div class="shoutbox-delete-box">
            <div style="margin-bottom:1em;">Are You Sure?</div>
            <div class="shoutbox-delete-btn-row"><button id="delete-yes">Yes</button><button id="delete-no">No</button></div>
          </div>
        </div>
      `;
      setTimeout(() => {
        attachShoutboxEvents();
      }, 0);
      return wrapper;
    }
    function attachShoutboxEvents() {
      document.getElementById('shoutbox-send').onclick = sendMessage;
      document.getElementById('shoutbox-input').onkeydown = function(e) {
        if (e.key === 'Enter') sendMessage();
      };
      // Set up auto-refresh every 2.2 seconds
      if (shoutboxInterval) clearInterval(shoutboxInterval);
      loadMessages();
      shoutboxInterval = setInterval(loadMessages, 2200);
      // Manual refresh button
      document.getElementById('refresh-shoutbox').onclick = loadMessages;
      // Resizing logic
      const container = document.querySelector('.shoutbox-main-container');
      const messagesDiv = document.getElementById('shoutbox-messages');
      const handle = document.querySelector('.shoutbox-resize-handle');
      let startY, startHeight;
      handle.addEventListener('mousedown', function(e) {
        startY = e.clientY;
        startHeight = parseInt(window.getComputedStyle(messagesDiv).maxHeight, 10);
        document.body.style.userSelect = 'none';
        function onMove(ev) {
          const newHeight = Math.max(200, Math.min(900, startHeight + (ev.clientY - startY)));
          messagesDiv.style.maxHeight = newHeight + 'px';
          localStorage.setItem('shoutbox-height', newHeight + 'px');
        }
        function onUp() {
          document.removeEventListener('mousemove', onMove);
          document.removeEventListener('mouseup', onUp);
          document.body.style.userSelect = '';
        }
        document.addEventListener('mousemove', onMove);
        document.addEventListener('mouseup', onUp);
      });
      // Context menu logic
      const contextMenu = document.getElementById('shoutbox-context-menu');
      document.addEventListener('click', () => { contextMenu.style.display = 'none'; });
      document.getElementById('edit-message-btn').onclick = function() {
        if (contextMsgId) startEditMessage(contextMsgId);
        contextMenu.style.display = 'flex';
      };
      document.getElementById('delete-message-btn').onclick = function() {
        if (contextMsgId) showDeleteConfirm(contextMsgId);
        contextMenu.style.display = 'none';
      };
      // Delete confirm popup
      const confirmBox = document.getElementById('shoutbox-delete-confirm');
      document.getElementById('delete-yes').onclick = async function() {
        if (deleteId) await deleteMessage(deleteId);
        confirmBox.style.display = 'none';
        deleteId = null;
      };
      document.getElementById('delete-no').onclick = function() {
        confirmBox.style.display = 'none';
        deleteId = null;
      };
    }
    async function loadMessages() {
      try {
        const res = await fetch(`${API_BASE}/api/messages`);
        messages = await res.json();
        renderMessages();
      } catch (e) {
        messages = [];
        renderMessages();
      }
    }
    function renderMessages() {
      const list = document.getElementById('shoutbox-messages');
      if (!list) return;
      list.innerHTML = '';
      messages.slice(-100).forEach((msg) => {
        const isOwn = msg.author === getCurrentUser();
        const isEditing = msg.id === editingMessageId;
        const msgEl = document.createElement('div');
        msgEl.className = 'shoutbox-message';
        msgEl.innerHTML = `
          <img src="${DEFAULT_PFP}" class="pfp" alt="pfp">
          <div class="shoutbox-message-content">
            <div class="shoutbox-message-meta">
              <a href="/profile.html?user=${encodeURIComponent(msg.author || 'Anonymous')}" class="profile-link" target="_blank">${escapeHTML(msg.author || 'Anonymous')}</a>
              <span class="shoutbox-message-time">${timeAgo(new Date(msg.createdAt))}</span>
            </div>
            <div class="shoutbox-message-body">${isEditing ? '' : escapeHTML(msg.body)}</div>
          </div>
          ${isOwn && !isEditing ? `<button class="shoutbox-dots-btn" title="Options"><i class="fas fa-ellipsis-v"></i></button>` : ''}
          ${isEditing ? `
            <input class="shoutbox-edit-input" type="text" value="${escapeHTML(msg.body)}" maxlength="500" style="width:100%;margin-top:4px;">
            <div style="margin-top:6px;display:flex;gap:8px;">
              <button class="shoutbox-edit-apply" style="background:#7f9cf5;color:#fff;">Apply</button>
              <button class="shoutbox-edit-cancel">Cancel</button>
            </div>
          ` : ''}
        `;
        // Dots button logic
        if (isOwn && !isEditing) {
          const dotsBtn = msgEl.querySelector('.shoutbox-dots-btn');
          if (dotsBtn) {
            dotsBtn.onclick = function(e) {
              e.stopPropagation();
              const contextMenu = document.getElementById('shoutbox-context-menu');
              contextMsgId = msg.id;
              contextMenu.style.display = 'flex';
              const rect = dotsBtn.getBoundingClientRect();
              contextMenu.style.left = rect.right - 120 + 'px';
              contextMenu.style.top = rect.bottom + 4 + 'px';
            };
          }
        }
        // Edit/Apply/Cancel logic
        if (isEditing) {
          setTimeout(() => {
            const input = msgEl.querySelector('.shoutbox-edit-input');
            input.removeAttribute('readonly');
            input.focus();
            msgEl.querySelector('.shoutbox-edit-apply').onclick = async () => {
              const newBody = input.value.trim();
              if (newBody && newBody !== msg.body) await editMessage(msg.id, newBody);
              editingMessageId = null;
              renderMessages();
            };
            msgEl.querySelector('.shoutbox-edit-cancel').onclick = () => {
              editingMessageId = null;
              renderMessages();
            };
          }, 0);
        }
        list.appendChild(msgEl);
      });
      list.scrollTop = list.scrollHeight;
    }
    async function sendMessage() {
      const input = document.getElementById('shoutbox-input');
      const body = input.value.trim();
      if (!body) return;
      try {
        const res = await fetch(`${API_BASE}/api/messages`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ body, author: getCurrentUser() })
        });
        if (!res.ok) {
          const data = await res.json();
          alert(data.error || 'Failed to send message');
          return;
        }
        input.value = '';
        await loadMessages();
      } catch (e) { alert('Failed to send message'); }
    }
    function timeAgo(date) {
      const now = new Date();
      const seconds = Math.floor((now - date) / 1000);
      if (seconds < 60) return `${seconds}s ago`;
      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return `${minutes}m ago`;
      const hours = Math.floor(minutes / 60);
      if (hours < 24) return `${hours}h ago`;
      const days = Math.floor(hours / 24);
      return `${days}d ago`;
    }
    function escapeHTML(str) {
      return str.replace(/[&<>"']/g, function(tag) {
        const chars = {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;'
        };
        return chars[tag] || tag;
      });
    }
    // --- LOGOUT ---
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        setCurrentUser(null);
        render();
      }
    });
    // --- INIT ---
    render();
    function renderProfileBar() {
      const user = getCurrentUser();
      const bar = document.createElement('div');
      bar.className = 'user-profile-bar';
      bar.innerHTML = `
        <span class="username">${escapeHTML(user)}</span>
        <img src="${DEFAULT_PFP}" class="pfp" id="profile-pfp" alt="Profile Picture">
        <div class="profile-dropdown" id="profile-dropdown">
          <button id="settings-btn" style="color:#fff;"><i class="fas fa-cog"></i> Settings</button>
          <button id="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</button>
        </div>
      `;
      setTimeout(() => attachProfileBarEvents(), 0);
      return bar;
    }
    function attachProfileBarEvents() {
      const pfp = document.getElementById('profile-pfp');
      const dropdown = document.getElementById('profile-dropdown');
      const logoutBtn = document.getElementById('logout-btn');
      const settingsBtn = document.getElementById('settings-btn');
      if (pfp) {
        pfp.onclick = function(e) {
          e.stopPropagation();
          dropdown.classList.toggle('show');
        };
      }
      if (logoutBtn) {
        logoutBtn.onclick = function() {
          setCurrentUser(null);
          render();
        };
      }
      if (settingsBtn) {
        settingsBtn.onclick = function() {
          dropdown.classList.remove('show');
          showSettingsModal();
        };
      }
      document.body.onclick = function() {
        dropdown.classList.remove('show');
      };
      dropdown.onclick = function(e) { e.stopPropagation(); };
    }
    function showDeleteConfirm(id) {
      const confirmBox = document.getElementById('shoutbox-delete-confirm');
      confirmBox.style.display = 'flex';
      deleteId = id;
    }
    function startEditMessage(id) {
      editingMessageId = id;
      renderMessages();
    }
    async function editMessage(id, newBody) {
      try {
        const res = await fetch(`${API_BASE}/api/messages/${id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ body: newBody })
        });
        if (!res.ok) {
          const data = await res.json();
          alert(data.error || 'Failed to edit message');
          return;
        }
        await loadMessages();
      } catch (e) {
        alert('Failed to edit message');
      }
    }
    async function deleteMessage(id) {
      try {
        const res = await fetch(`${API_BASE}/api/messages/${id}`, { method: 'DELETE' });
        if (!res.ok) {
          const data = await res.json();
          alert(data.error || 'Failed to delete message');
          return;
        }
        await loadMessages();
      } catch (e) {
        alert('Failed to delete message');
      }
    }
    function stopOnlineTracking() {
      if (heartbeatInterval) clearInterval(heartbeatInterval);
      if (onlineInterval) clearInterval(onlineInterval);
    }
    // On page load, restore members online box state
    document.addEventListener('DOMContentLoaded', () => {
      if (localStorage.getItem('membersOnlineHidden') === '1') {
        setTimeout(() => {
          const box = document.querySelector('.members-online-box');
          if (box) box.classList.add('hide');
        }, 100);
      }
    });
    (function(){
      const API_BASE = 'http://localhost:3001';
      function renderStatsBar() {
        const statsBar = document.createElement('div');
        statsBar.className = 'stats-bar';
        statsBar.innerHTML = `
          <div class="stats-title">Statistics</div>
          <div class="stats-box"><span id="stats-threads">-</span><br><span class="stats-label">Threads</span></div>
          <div class="stats-box"><span id="stats-messages">-</span><br><span class="stats-label">Messages</span></div>
          <div class="stats-box"><span id="stats-members">-</span><br><span class="stats-label">Members</span></div>
          <div class="stats-box"><span id="stats-latest">-</span><br><span class="stats-label">Latest member</span></div>
        `;
        document.getElementById('forum-stats-bar').appendChild(statsBar);
        const statsStyle = document.createElement('style');
        statsStyle.textContent = `
          .stats-bar {
            display: flex;
            align-items: stretch;
            background: #191a22;
            border-radius: 12px;
            margin: 2.5em auto 0 auto;
            max-width: 900px;
            box-shadow: 0 2px 12px #0002;
            padding: 1.1em 1.2em 1.1em 1.2em;
            gap: 0.7em;
            font-family: inherit;
          }
          .stats-title {
            color: #fff;
            font-weight: 700;
            font-size: 1.1em;
            margin-right: 1.2em;
            align-self: center;
          }
          .stats-box {
            background: #8f2fff;
            color: #fff;
            border-radius: 7px;
            padding: 0.7em 1.2em;
            font-size: 1.25em;
            font-weight: 700;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 110px;
            margin-right: 0.5em;
          }
          .stats-label {
            font-size: 0.93em;
            font-weight: 400;
            color: #fff;
            opacity: 0.93;
          }
        `;
        document.head.appendChild(statsStyle);
      }
      function loadStats() {
        fetch('http://localhost:3001/api/stats')
          .then(res => res.json())
          .then(stats => {
            document.getElementById('stats-threads').textContent = stats.threads;
            document.getElementById('stats-messages').textContent = stats.messages;
            document.getElementById('stats-members').textContent = stats.members;
            document.getElementById('stats-latest').textContent = stats.latestMember;
          });
      }
      document.addEventListener('DOMContentLoaded', function() {
        renderStatsBar();
        loadStats();
        setInterval(loadStats, 10000);
      });
    })();
    // --- Settings Modal ---
    function showSettingsModal() {
      // Blur overlay
      let blur = document.getElementById('settings-blur');
      if (!blur) {
        blur = document.createElement('div');
        blur.id = 'settings-blur';
        blur.style.position = 'fixed';
        blur.style.top = '0';
        blur.style.left = '0';
        blur.style.width = '100vw';
        blur.style.height = '100vh';
        blur.style.background = 'rgba(24,24,40,0.55)';
        blur.style.backdropFilter = 'blur(7px)';
        blur.style.zIndex = '99998';
        document.body.appendChild(blur);
      } else {
        blur.style.display = 'block';
      }
      // Modal
      let modal = document.getElementById('settings-modal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'settings-modal';
        modal.style.position = 'fixed';
        modal.style.top = '50%';
        modal.style.left = '50%';
        modal.style.transform = 'translate(-50%, -50%)';
        modal.style.background = '#23262e';
        modal.style.borderRadius = '18px';
        modal.style.boxShadow = '0 8px 32px #000a';
        modal.style.minWidth = '370px';
        modal.style.maxWidth = '95vw';
        modal.style.zIndex = '99999';
        modal.style.padding = '0';
        modal.innerHTML = `
          <div style="display:flex;align-items:center;justify-content:space-between;padding:1.2em 2em 0.5em 2em;">
            <div style="font-size:1.3em;font-weight:800;color:#fff;">Settings</div>
            <button id="settings-modal-close" style="background:none;border:none;color:#fff;font-size:1.5em;cursor:pointer;"><i class="fas fa-times"></i></button>
          </div>
          <div style="display:flex;gap:0.5em;padding:0 2em 0 2em;">
            <button class="settings-tab-btn" id="settings-tab-privacy" style="flex:1;font-size:1.08em;font-weight:700;color:#fff;background:none;border:none;padding:0.7em 0;border-bottom:3px solid #353945;cursor:pointer;">Privacy</button>
            <button class="settings-tab-btn" id="settings-tab-security" style="flex:1;font-size:1.08em;font-weight:700;color:#fff;background:none;border:none;padding:0.7em 0;border-bottom:3px solid #7f9cf5;cursor:pointer;">Security</button>
          </div>
          <div id="settings-tab-content" style="padding:2em 2em 2em 2em;">
            <!-- Security tab by default -->
            <div id="settings-security">
              <div style="margin-bottom:1.5em;">
                <div style="font-size:1.08em;color:#bfc3d1;margin-bottom:0.3em;">Linked email</div>
                <div style="display:flex;align-items:center;gap:1em;">
                  <span id="settings-email" style="font-size:1.13em;font-weight:700;color:#fff;">Loading...</span>
                  <button id="settings-change-email" style="background:none;border:none;color:#7f9cf5;font-weight:700;cursor:pointer;">Change</button>
                </div>
                <div id="settings-email-change-form" style="display:none;margin-top:1em;">
                  <input id="settings-email-current-password" type="password" placeholder="Current password" style="width:100%;margin-bottom:0.7em;padding:0.8em 1em;border-radius:8px;border:1.5px solid #353945;background:#181a20;color:#fff;font-size:1.08em;outline:none;">
                  <button id="settings-email-verify-password" style="width:100%;padding:0.7em 0;border-radius:8px;background:linear-gradient(135deg,#667eea 0%,#ff6b6b 100%);color:#fff;font-weight:700;font-size:1em;border:none;cursor:pointer;margin-bottom:0.7em;">Verify Password</button>
                  <div id="settings-email-code-section" style="display:none;">
                    <input id="settings-email-code-input" maxlength="4" placeholder="Enter code from email" style="width:100%;margin-bottom:0.7em;padding:0.8em 1em;border-radius:8px;border:1.5px solid #7f9cf5;background:#181a20;color:#fff;font-size:1.08em;outline:none;letter-spacing:0.4em;text-align:center;">
                    <button id="settings-email-verify-code" style="width:100%;padding:0.7em 0;border-radius:8px;background:linear-gradient(135deg,#667eea 0%,#ff6b6b 100%);color:#fff;font-weight:700;font-size:1em;border:none;cursor:pointer;">Verify Code</button>
                  </div>
                </div>
              </div>
              <div style="margin-top:2.2em;">
                <div style="font-size:1.08em;color:#bfc3d1;margin-bottom:0.3em;">Reset password</div>
                <input id="settings-reset-current-password" type="password" placeholder="Current password" style="width:100%;margin-bottom:0.7em;padding:0.8em 1em;border-radius:8px;border:1.5px solid #353945;background:#181a20;color:#fff;font-size:1.08em;outline:none;">
                <input id="settings-reset-new-password" type="password" placeholder="New password" style="width:100%;margin-bottom:0.7em;padding:0.8em 1em;border-radius:8px;border:1.5px solid #353945;background:#181a20;color:#fff;font-size:1.08em;outline:none;">
                <input id="settings-reset-confirm-password" type="password" placeholder="Confirm new password" style="width:100%;margin-bottom:0.7em;padding:0.8em 1em;border-radius:8px;border:1.5px solid #353945;background:#181a20;color:#fff;font-size:1.08em;outline:none;">
                <button id="settings-reset-password-btn" style="width:100%;padding:0.7em 0;border-radius:8px;background:linear-gradient(135deg,#667eea 0%,#ff6b6b 100%);color:#fff;font-weight:700;font-size:1em;border:none;cursor:pointer;">Reset Password</button>
              </div>
            </div>
            <div id="settings-privacy" style="display:none;">
              <div style="font-size:1.1em;color:#fff;">Privacy settings coming soon.</div>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      } else {
        modal.style.display = 'block';
      }
      // Tab logic
      document.getElementById('settings-tab-privacy').onclick = function() {
        document.getElementById('settings-privacy').style.display = '';
        document.getElementById('settings-security').style.display = 'none';
        this.style.borderBottom = '3px solid #7f9cf5';
        document.getElementById('settings-tab-security').style.borderBottom = '3px solid #353945';
      };
      document.getElementById('settings-tab-security').onclick = function() {
        document.getElementById('settings-privacy').style.display = 'none';
        document.getElementById('settings-security').style.display = '';
        this.style.borderBottom = '3px solid #7f9cf5';
        document.getElementById('settings-tab-privacy').style.borderBottom = '3px solid #353945';
      };
      // Close logic
      document.getElementById('settings-modal-close').onclick = function() {
        modal.style.display = 'none';
        blur.style.display = 'none';
      };
      // Fetch and display the user's email
      let user = getCurrentUser();
      let username = extractUsername(user);
      // Support UID or username for email fetch
      async function fetchAndShowEmail(identifier) {
        let uname = identifier;
        if (/^\d+$/.test(identifier)) { // If all digits, treat as UID
          try {
            const res = await fetch(`${API_BASE}/api/user-by-uid/${identifier}`);
            if (res.ok) {
              const data = await res.json();
              uname = data.username;
            } else {
              document.getElementById('settings-email').textContent = '(user not found)';
              return;
            }
          } catch {
            document.getElementById('settings-email').textContent = '(error)';
            return;
          }
        }
        fetch(`${API_BASE}/api/user-email/${encodeURIComponent(uname)}`)
          .then(res => res.json())
          .then(data => {
            const emailSpan = document.getElementById('settings-email');
            const changeBtn = document.getElementById('settings-change-email');
            if (!data.email) {
              emailSpan.textContent = '(not set)';
              changeBtn.textContent = 'Set Email';
              changeBtn.onclick = function() { showSetEmailForm(uname); };
            } else {
              emailSpan.textContent = data.email;
              changeBtn.textContent = 'Change';
              changeBtn.onclick = function() { showChangeEmailForm(uname, data.email); };
            }
          })
          .catch(() => {
            document.getElementById('settings-email').textContent = '(error)';
          });
      }
      if (username) {
        fetchAndShowEmail(username);
      }
      // Password reset logic
      const resetBtn = document.getElementById('settings-reset-password-btn');
      if (resetBtn) {
        resetBtn.onclick = async function() {
          const current = document.getElementById('settings-reset-current-password').value;
          const newPass = document.getElementById('settings-reset-new-password').value;
          const confirm = document.getElementById('settings-reset-confirm-password').value;
          if (!current || !newPass || !confirm) {
            showSettingsNotification('Please fill in all fields.', 'error');
            return;
          }
          if (newPass !== confirm) {
            showSettingsNotification('New passwords do not match.', 'error');
            return;
          }
          showProceedingOverlay('Changing password...');
          try {
            const res = await fetch(`${API_BASE}/api/change-password`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ username, current, newPass })
            });
            hideProceedingOverlay();
            if (!res.ok) {
              const data = await res.json();
              showSettingsNotification(data.error || 'Failed to change password.', 'error');
              return;
            }
            showSettingsNotification('Password changed successfully!', 'success');
            document.getElementById('settings-reset-current-password').value = '';
            document.getElementById('settings-reset-new-password').value = '';
            document.getElementById('settings-reset-confirm-password').value = '';
          } catch (e) {
            hideProceedingOverlay();
            showSettingsNotification('Failed to change password.', 'error');
          }
        };
      }
      // Add Delete My Account button
      if (!document.getElementById('settings-delete-account-btn')) {
        const delBtn = document.createElement('button');
        delBtn.id = 'settings-delete-account-btn';
        delBtn.textContent = 'Delete My Account';
        delBtn.style = 'width:100%;padding:0.7em 0;margin-top:1.5em;border-radius:8px;background:linear-gradient(135deg,#ff6b6b 0%,#e53e3e 100%);color:#fff;font-weight:700;font-size:1em;border:none;cursor:pointer;';
        delBtn.onclick = async function() {
          if (confirm('Are you sure you want to delete your account? This cannot be undone!')) {
            showProceedingOverlay('Deleting account...');
            try {
              const res = await fetch(`${API_BASE}/api/delete-member`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username })
              });
              hideProceedingOverlay();
              if (!res.ok) {
                const data = await res.json();
                showSettingsNotification(data.error || 'Failed to delete account.', 'error');
                return;
              }
              localStorage.removeItem('forumCurrentUser');
              alert('Account deleted.');
              window.location.reload();
            } catch (e) {
              hideProceedingOverlay();
              showSettingsNotification('Failed to delete account.', 'error');
            }
          }
        };
        modal.querySelector('.settings-modal-content').appendChild(delBtn);
      }
    }
    // --- Notification helper for settings ---
    function showSettingsNotification(msg, type = 'success') {
      let notif = document.getElementById('settings-notif');
      if (!notif) {
        notif = document.createElement('div');
        notif.id = 'settings-notif';
        notif.style.position = 'fixed';
        notif.style.bottom = '32px';
        notif.style.left = '50%';
        notif.style.transform = 'translateX(-50%)';
        notif.style.background = type === 'success' ? 'linear-gradient(135deg,#7f9cf5 0%,#67e6dc 100%)' : 'linear-gradient(135deg,#ff6b6b 0%,#e53e3e 100%)';
        notif.style.color = '#fff';
        notif.style.borderRadius = '12px';
        notif.style.boxShadow = '0 4px 24px #0008';
        notif.style.padding = '1em 2em';
        notif.style.fontSize = '1.08em';
        notif.style.fontWeight = '700';
        notif.style.zIndex = '20010';
        notif.style.opacity = '0';
        notif.style.transition = 'opacity 0.3s, bottom 0.3s';
        document.body.appendChild(notif);
      }
      notif.textContent = msg;
      notif.style.opacity = '1';
      notif.style.bottom = '32px';
      setTimeout(() => {
        notif.style.opacity = '0';
        notif.style.bottom = '0px';
      }, 3200);
    }
    // --- Proceeding overlay ---
    function showProceedingOverlay(text = 'Proceeding...') {
      let overlay = document.getElementById('proceeding-overlay');
      if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'proceeding-overlay';
        overlay.style.position = 'fixed';
        overlay.style.top = '0';
        overlay.style.left = '0';
        overlay.style.width = '100vw';
        overlay.style.height = '100vh';
        overlay.style.background = 'rgba(24,24,40,0.55)';
        overlay.style.backdropFilter = 'blur(7px)';
        overlay.style.zIndex = '20020';
        overlay.style.display = 'flex';
        overlay.style.alignItems = 'center';
        overlay.style.justifyContent = 'center';
        overlay.innerHTML = `<div style="background:#23262e;padding:2.2em 2.5em;border-radius:16px;box-shadow:0 4px 32px #0008;min-width:320px;max-width:90vw;text-align:center;color:#fff;font-size:1.25em;font-weight:700;letter-spacing:0.03em;"><span class="proceeding-spinner" style="display:inline-block;width:2.2rem;height:2.2rem;border:4px solid #764ba2;border-top:4px solid #fff;border-radius:50%;margin-right:1rem;vertical-align:middle;animation:spin 1s linear infinite;"></span><span id="proceeding-overlay-text">${text}</span></div>`;
        document.body.appendChild(overlay);
      } else {
        document.getElementById('proceeding-overlay-text').textContent = text;
        overlay.style.display = 'flex';
      }
    }
    function hideProceedingOverlay() {
      let overlay = document.getElementById('proceeding-overlay');
      if (overlay) overlay.style.display = 'none';
    }
    // --- Universal username extraction helper ---
    function extractUsername(raw) {
      if (!raw) return '';
      let username = raw;
      if (username.includes(':')) username = username.split(':')[0];
      if (username.includes('.')) username = username.split('.')[0];
      return username;
    }
    // --- Set Email Form ---
    function showSetEmailForm(username) {
      let popup = document.getElementById('register-popup');
      if (!popup) {
        popup = document.createElement('div');
        popup.id = 'register-popup';
        document.body.appendChild(popup);
      }
      popup.style.position = 'fixed';
      popup.style.top = '0';
      popup.style.left = '0';
      popup.style.width = '100vw';
      popup.style.height = '100vh';
      popup.style.background = 'rgba(24,24,40,0.55)';
      popup.style.display = 'flex';
      popup.style.alignItems = 'center';
      popup.style.justifyContent = 'center';
      popup.style.zIndex = '99999';
      popup.innerHTML = `<div style="background:#23262e;padding:2.2em 2.5em;border-radius:16px;box-shadow:0 4px 32px #0008;min-width:320px;max-width:90vw;text-align:center;color:#fff;font-size:1.15em;">
    <div style='margin-bottom:1.2em;'>Enter your email address:</div>
    <input id="set-email-input" type="email" placeholder="Email address" style="font-size:1.1em;text-align:center;padding:0.7em 1.2em;border-radius:8px;border:1.5px solid #7f9cf5;background:#181a20;color:#fff;width:16em;outline:none;"><br>
    <button id="set-email-send-code" style="margin-top:1.2em;padding:0.7em 2.2em;border-radius:8px;background:linear-gradient(135deg,#667eea 0%,#ff6b6b 100%);color:#fff;font-weight:700;font-size:1em;border:none;cursor:pointer;">Send Code</button>
    <div id="set-email-error" style="color:#ff6b6b;margin-top:0.7em;font-size:0.98em;"></div>
  </div>`;
      document.getElementById('set-email-send-code').onclick = async function() {
        const email = document.getElementById('set-email-input').value.trim();
        if (!/^([a-zA-Z0-9_\-.+]+)@([a-zA-Z0-9\-.]+)\.([a-zA-Z]{2,})$/.test(email)) {
          document.getElementById('set-email-error').textContent = 'Please enter a valid email address.';
          return;
        }
        // Generate code and send via EmailJS
        const code = Math.random().toString(36).substring(2, 6).toUpperCase();
        if (!window.emailjs) return document.getElementById('set-email-error').textContent = 'Email service not loaded.';
        emailjs.init('z2WmcwjGtarSEt6kH');
        const now = new Date();
        const time = now.toLocaleString();
        const templateParams = {
          time,
          name: username,
          message: `Your verification code is: ${code}`,
          email,
          title: '4EXT Forum Email Verification'
        };
        try {
          await emailjs.send('service_s228403', 'template_byoru3i', templateParams);
        } catch (e) {
          document.getElementById('set-email-error').textContent = 'Failed to send verification email.';
          return;
        }
        // Show code input
        popup.innerHTML = `<div style=\"background:#23262e;padding:2.2em 2.5em;border-radius:16px;box-shadow:0 4px 32px #0008;min-width:320px;max-width:90vw;text-align:center;color:#fff;font-size:1.15em;\"><div style='margin-bottom:1.2em;'>Enter the 4-character code sent to your email:</div><input id=\"set-email-code-input\" maxlength=\"4\" style=\"font-size:1.5em;text-align:center;letter-spacing:0.4em;padding:0.7em 1.2em;border-radius:8px;border:1.5px solid #7f9cf5;background:#181a20;color:#fff;width:8em;outline:none;\"><br><button id=\"set-email-verify-code\" style=\"margin-top:1.5em;padding:0.7em 2.2em;border-radius:8px;background:linear-gradient(135deg,#667eea 0%,#ff6b6b 100%);color:#fff;font-weight:700;font-size:1em;border:none;cursor:pointer;\">Verify</button><div id=\"set-email-error\" style=\"color:#ff6b6b;margin-top:0.7em;font-size:0.98em;\"></div></div>`;
        document.getElementById('set-email-verify-code').onclick = async function() {
          const entered = document.getElementById('set-email-code-input').value.trim().toUpperCase();
          if (entered !== code) {
            document.getElementById('set-email-error').textContent = 'Incorrect code. Please try again.';
            return;
          }
          // Update email via backend
          try {
            const res = await fetch(`${API_BASE}/api/set-email`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ username, email })
            });
            if (!res.ok) {
              document.getElementById('set-email-error').textContent = 'Failed to set email.';
              return;
            }
            popup.style.display = 'none';
            showSettingsNotification('Email set successfully!', 'success');
            // Refresh settings modal email
            document.getElementById('settings-email').textContent = email;
            document.getElementById('settings-change-email').textContent = 'Change';
          } catch (e) {
            document.getElementById('set-email-error').textContent = 'Failed to set email.';
          }
        };
      };
    }
    // --- Ban check for current user ---
    async function showBanOverlay(reason) {
      document.body.innerHTML = `<div style='display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;background:#181a20;color:#fff;z-index:999999;position:fixed;top:0;left:0;right:0;bottom:0;width:100vw;'><div style='font-size:2.2em;font-weight:900;margin-bottom:0.7em;color:#ff3b3b;'>You have been banned by a mod</div><div style='font-size:1.2em;margin-bottom:1.5em;'>PERMANENT BAN - Until unbanned</div><div style='background:#23262e;padding:1.5em 2.5em;border-radius:14px;box-shadow:0 4px 32px #0008;max-width:90vw;font-size:1.1em;color:#ffb3b3;'>Reason: <b>${reason ? escapeHTML(reason) : 'No reason provided.'}</b></div></div>`;
      localStorage.removeItem('forumCurrentUser');
    }
    async function checkCurrentUserBan() {
      const user = getCurrentUser();
      if (!user) return false;
      try {
        const res = await fetch(`${API_BASE}/api/user/${encodeURIComponent(user)}`);
        if (!res.ok) return false;
        const data = await res.json();
        if (data.banned) {
          setCurrentUser(null);
          showBanOverlay(data.banReason);
          return true;
        }
      } catch {}
      return false;
    }
    // Patch render to always check ban before rendering main UI
    const origRender = render;
    render = async function() {
      const banned = await checkCurrentUserBan();
      if (!banned) origRender();
    };
    // On page load, check ban immediately
    checkCurrentUserBan();
  </script>
</body>
</html> 